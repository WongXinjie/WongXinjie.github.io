title: Redis数据安全
date: 2016-08-25 22:09:25
categories: Redis
tags:
- 笔记
---



Redis虽然是内存型(in-memory)数据数据库，但同时也提供了持久化 选项可以将数据保存到硬盘中，正确地配置这些持久化设置，可以在服务器挂了时将数据损失降到最低。redis提供了两种方法对数据进行持久化，分别是**snapshotting(快照)**和**AOF(append-only file, 只追加文件)**, 这两种方法可以单独使用或者搭配使用，也可以都不用。Redis在线文档和配置文件（通常在/etc/redis.conf)都写的很仔细。

##### 快照持久化

快照就是将某一时刻将Redis存储的所有数据写到硬盘里，其功能就相当于一个数据备份。快照可以用来在多台机器上建立具有相同数据内容的服务，或者在重启机器时恢复数据。快照相关的配置如下：

```
save 60 10000 # 60s内有10000次写入则自动调用bgsave创建快照
stop-writes-on-bgsaves-error no  #创建快照失败是否继续执行
rdbcompression yes # 是否对快照文件进行压缩
dbfilename dump.rdb # 快照文件名
```
<!--more-->

通常在以下情况会创建快照：

* 客户端主动发送BGSAVE命令来创建一个快照。这是Redis会fork一个子进程来负责将快照文件写入硬盘，而父进程则继续处理请求。
* 客户端主动发送SAVE命令来创建一个快照。Redis服务器在收到这个命令后在快照创建完成之前将不会响应任何其他命令。
* 根据用户的配置(redis.conf)选项，如save 60 1000。当条件被满足时，Redis就会触发BGSAVE命令。用户可以设置多个save配置选项，其中任何一个满足条件便会创建快照。
* Redis通过shutdown命令接收到关闭服务命令，或者收到TERM命令，这时会执行SAVE命令，执行完毕之后关闭服务。
* 作为主服务器收到从Redis服务器的SYNC命令，Redis服务器可能会执行BGSAVE命令生成快照。

当应用程序可以忍受丢失一部分数据的风险时可以只使用快照进行持久化，因为一旦系统崩溃，最近快照之后的数据将会全部丢失。除此之外，因为创建快照时将Redis内的所有数据写到硬盘，在数据量很大的时候(几十G)，或者机器剩余的内存不多的时候，Redis执行BGSAVE 时回导致系统长时间的停顿，这会影响Redis的性能。Redis在执行BGSAVE时创建子进程时不回响应任何命令，而创建子进程所需的时间会随数据的增加而增长。

所以在生产中可以考虑关闭自动保存，转而通过手动发送BGSAVE或者SAVE命令来进行持久化。

##### AOF持久化

AOF持久化便是Redis将所有被执行的写命令添加到AOF文件，以此来记录数据的变化，所有Redis执行一遍AOF文件的写命令，就可以恢复AOF记录的所有数据集。AOF的相关配置如下：

```
appendonly on # 是否开启AOF持久化，默认为否，开启为yes
appendfsync everysec 
no-appendfsync-on-rewrite no 
# 当AOF文件大小大于64MB, 并且比上一次重写后大小大了100%则进行重写
auto-aof-rewrite-percentage 100 
auto-aof-rewrite-min-size 64m 

dir ./ #这个和快照公用，决定rdb和aof文件存放目录
```

在配置中appendfsync选项有always/everysec/no三个选项。

always会将每一个写命令都强制写入(file.flush)硬盘，此时Redis的性能会受硬盘性能的限制，数据丢失最少但对硬盘寿命的影响极大。 

everysec则是将写命令存储到系统缓冲区，然后以每秒一次的频率将写命令同步到AOF文件，兼顾了数据安全和写入性能，也是推荐的设置。

no则Redis不会对AOF文件进行任何同步操作，由操作系统决定何时将缓冲区的内容写入AOF文件，这个选项不会对Redis性能造成影响。但潜在的问题是无法确定丢失多少数据，同时如果操作系统写入硬盘的速度不够快导致写入缓冲区写满时，Redis写入操作会被阻塞，这时会影响Redis处理请求的速度，所以也不推荐。

AOF既可以将数据丢失降低到何少，同时又能极短的进行写入同步，看起来的确是很好的持久化方案，但实际上也存在问题，其中一个就是文件大小问题。Redis运行的时间越长，写入命令越多，则AOF文件可能会占用很大的空间，同时在Redis在读取AOF还原数据时时间过长以至到不能忍受的地步。

要解决AOF文件不断增大问题，客户端可以发送BGREWRITEAOF命令对AOF命令进行重写。AOF重写即通过删除AOF中冗余的写入命令来减小文件大小。BGREWRITEAOF重写的原理和BGSAVE的原理相识：创建子进程，所以快照存在的子进程创建时间问题和内存占用问题同样存在。更糟的是，AOF文件的大小远比快照文件大，进行重写AOF和删除旧文件时，删除一个几十G文件会造成系统的卡顿。

##### 复制

快照和AOF都是单机情况下的通过持久化来保证数据安全，但也可以通过配置将数据的副本复制到其他的机器，不仅可以避免数据的丢失，同时也可以通过主库写从库读的方案降低Redis压力。
